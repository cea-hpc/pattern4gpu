#!/bin/bash

write_arc_file="@P4G_TESTS@/@TEST_DIR@/@WRITE_TEST_NAME@.arc"
write_log_file="@OUTPUT_DIR@/write_@WRITE_TEST_NAME@.log"

read_arc_file="@P4G_TESTS@/@TEST_DIR@/@READ_TEST_NAME@.arc"
read_log_file="@OUTPUT_DIR@/read_@READ_TEST_NAME@.log"

vdiff_file="@OUTPUT_DIR@/vdiff.log"

mkdir -p "@OUTPUT_DIR@"

echo "Write... (listing in $write_log_file)"
STDENV_VERIF=WRITE @P4G_EXE@ -A,MaxIteration=@MAX_ITER@ @WRITE_ARCANE_PARAM@ "$write_arc_file" > "$write_log_file"
if [ $? -ne 0 ]; then
  return 1
fi

echo "Read... (listing in $read_log_file)"
STDENV_VERIF=READ @P4G_EXE@ -A,MaxIteration=@MAX_ITER@ @READ_ARCANE_PARAM@ "$read_arc_file" > "$read_log_file"
if [ $? -ne 0 ]; then
  return 1
fi

grep -nr "VDIFF: Variable" "$read_log_file" > "$vdiff_file"
if [ $? -ne 0 ]; then
  echo "Pas de différences"
  return 0
fi

while IFS= read -r line; do
  echo "Différence dans le listing : $line"
  j=$(echo "$line" | grep -oP "[0-9]+\.+[0-9]+e?\-?[0-9]*$")
  echo "Abs rdiff récupéré : $j"
  r=$(awk -v a="$j" -v b="@EPSILON@" 'BEGIN{print (a>b)?1:0}')
  echo "$j > @EPSILON@ ? : $r"
  if [ $r -ne 0 ]; then
    echo "Différence détectée"
    return 1
  fi
done < "$vdiff_file"
